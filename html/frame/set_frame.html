<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>设置</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <!-- <link rel="stylesheet" type="text/css" href="../../css/style.css" /> -->
    <style>
        html,
        body {
            height: 100%;
            background-color: #f4f4f4;
            width: 100%;
        }

        .set_user {
            width: calc(100%- 12px);
            height: 110px;
            background: #fff;
            margin-left: 12px;
        }

        .set_area {
            width: 100%;
            height: auto;
            background: #fff;
            overflow: hidden;
        }

        .set_img {
            width: 50px;
            height: 50px;
            background-size: 100% 100%;
            float: left;
            margin-top: 30px;
            border-radius: 50%;
        }

        .user_zl {
            height: 50px;
            width: calc(100% - 97px);
            margin-left: 16px;
            float: left;
            margin-top: 30px;
        }

        .user_zh {
            width: 100%;
            height: 25px;
            line-height: 25px;
        }

        .check_edit {
            color: #888;
            font-size: 0.8rem;
        }

        .mine_forward {
            margin-top: 42px;
        }

        .set_item {
            width: calc(100% - 12px);
            height: 55px;
            background: #fff;
            margin-left: 12px;
            position: relative;
        }

        .set_right {
            width: 25px;
            height: 25px;
            float: right;
        }

        img {
            width: 100%;
            height: 100%;
            background-size: 100% 100%;
        }

        .set_border {
            border-bottom: solid 1px #dddddd;
        }

        .set_left {
            height: 24px;
            width: 24px;
            float: left;
            background-size: 100% 100%;
            margin-top: 15px;
            margin-right: 10px;
        }

        .set_middle {
            width: auto;
            height: 55px;
            float: left;
            line-height: 55px;
            font-size: 0.9rem;
        }

        .set_version {
            width: 180px;
            height: 55px;
            line-height: 55px;
            position: absolute;
            color: #888;
            text-align: right;
            right: 30px;
            top: 0;
            font-size: 0.9rem;
        }

        .forward_top {
            margin-top: 16px;
        }

        .set_top {
            margin-top: 10px;
        }

        .set_out {
            width: 100%;
            text-align: center;
            color: #f94529;
            line-height: 55px;
            font-size: 1.0rem;
            font-weight: bolder;
        }
    </style>
</head>

<body>
    <div class="set_area">
        <div class="set_user set_border">
            <img src="../../image/appicon_108.png" alt="" class="set_img" id="user_headImg">
            <div class="user_zl" onclick="fnOpenFunction('mine_info_win');">
                <div class="user_zh" id="nickname">还木有昵称哦~</div>
                <div class="check_edit user_zh">查看和编辑个人资料</div>
            </div>
            <div class="set_right mine_forward"><img src="../../image/home/mine_forward.png" alt=""></div>
        </div>
        <div class="set_item" onclick="fnOpenFunction('address_win');">
            <img src="../../image/mine_feedback.png" alt="" class="set_left">
            <div class="set_middle">我的收货地址</div>
            <div class="set_right forward_top">
                <img src="../../image/home/mine_forward.png" alt="">
            </div>
        </div>
    </div>
    <div class="set_area set_top">
        <div class="set_item" onclick="fnOpenFunction('zhanghuanquan_win');">
            <img src="../../image/grzx_icon_sz.png" alt="" class="set_left">
            <div class="set_middle">账户与安全</div>
            <div class="set_right forward_top">
                <img src="../../image/home/mine_forward.png" alt="">
            </div>
        </div>
    </div>
    <div class="set_area set_top">
        <div class="set_item set_border" onclick="fnOpenFunction('xiaoxitixing_win');">
            <img src="../../image/grzx_icon_fk.png" alt="" class="set_left">
            <div class="set_middle">消息通知</div>
            <div class="set_right forward_top">
                <img src="../../image/home/mine_forward.png" alt="">
            </div>
        </div>
        <div class="set_item" onclick="fnOpenFunction('about_us_win');">
            <img src="../../image/grzx_icon_fxzsy.png" alt="" class="set_left">
            <div class="set_middle">关于我们</div>
            <div class="set_right forward_top">
                <img src="../../image/home/mine_forward.png" alt="">
            </div>
        </div>
    </div>
    <div class="set_area set_top">
        <div class="set_item  set_border" id='Check_update' onclick="Check_update();">
            <div class="set_middle">检查更新</div>
            <div class="set_version">当前版本V<span id='Version'></span></div>
            <div class="set_right forward_top">
                <img src="../../image/home/mine_forward.png" alt="">
            </div>
        </div>
        <div class="set_item" onclick="fnClearCache();">
            <div class="set_middle">清理缓存</div>
            <div class="set_version"><a id="cacheSize">0.00KB</a></div>
            <div class="set_right forward_top">
                <img src="../../image/home/mine_forward.png" alt="">
            </div>
        </div>
    </div>
    <div class="set_area set_top" onclick="fnLoginOut();">
        <div class="set_item  set_border" style="border-bottom: solid 0px #dddddd;">
            <div class="set_out">退出登录</div>
        </div>
    </div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery.js"></script>
<script type="text/javascript" src="../../script/api_common.js"></script>
<script type="text/javascript" src="../../script/md5.js"></script>
<script type="text/javascript">
    var user_id;
    apiready = function() {
            var appVersion = api.appVersion; // 比如： 1.0.0
            $api.byId('Version').innerHTML = appVersion;
            if (api.systemType == "ios") {
                $('#Check_update').hide();
            }
            user_id = $api.getStorage("userInfo").user_id;
            api.addEventListener({
                name: 'login'
            }, function(ret, err) {
                if (ret) {
                    //  alert( JSON.stringify( ret ) );
                    if (ret.value.login) {
                        location.reload();
                    }
                } else {
                    //  alert( JSON.stringify( err ) );
                }
            });
            if (empty(user_id)) {
                api.openWin({
                    name: 'user_login',
                    url: '../login/user_login.html',
                    reload: true,
                    bounces: false
                });
            } else {
                getUserInfo();
            }
            api.getCacheSize(function(ret, err) {
                var size = parseInt(ret.size / 1048576 * 100) / 1000 + 'MB';

                cacheSize.innerHTML = size;
            });
        }
        //打开相关页面；
    function fnOpenFunction(winName) {
        api.openWin({
            name: winName,
            url: '../win/' + winName + '.html',
            pageParam: {
                name: 'test'
            }
        });
    }
    //获取用户信息
    function getUserInfo() {
        var obj = {
            'user_id': user_id
        };
        var objArr = sort_ASCII(obj);
        var timestamp = fntimestamp();
        var version = '2.0';
        var arr = apiSecret + timestamp + version + '';
        for (i in objArr) {
            arr += objArr[i];
        }
        var sign = hex_md5(arr);
        api.ajax({
            url: commonUrl + 'soukeAppTttService/service/user/message_ac',
            method: 'post',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            data: {
                body: {
                    'apiKey': apiKey,
                    'timestamp': timestamp,
                    'sign': sign,
                    'user_id': user_id,
                }
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.result_code == 200) {
                    // console.log("用户信息"+JSON.stringify(ret));
                    $("#user_headImg").attr("src", ret.result_user.head);
                    $api.byId('nickname').innerHTML = ret.result_user.nickname;
                } else {
                    api.toast({
                        msg: ret.result_message,
                        duration: 2000,
                        location: 'middle'
                    });
                }
            } else {
                // api.alert({ msg: JSON.stringify(err) });
            }
        });
    }

    function fnLoginOut() {
        var buttons;
        var i;
        if (api.systemType == 'android') {
            buttons = ['退出', '取消'];
            i = 1;
        } else {
            buttons = ['取消', '退出'];
            i = 2;
        }
        api.confirm({
            title: '提示',
            msg: '是否退出登录？',
            buttons: buttons
        }, function(ret, err) {
            if (ret) {
                var index = ret.buttonIndex;
                if (index == i) {
                    $api.clearStorage("userinfo");
                    var alibaichuan = api.require('mAliBaiChuan');
                    alibaichuan.logout(function(ret, err) {
                        if (ret) {
                            // alert("用户信息 ret - " + JSON.stringify(ret));
                        } else {
                            // alert("用户信息 err - " + JSON.stringify(err));
                        }
                    });
                    api.execScript({
                        name: 'main',
                        frameName: 'my_frame',
                        script: 'window.location();'
                    });
                    api.sendEvent({
                        name: 'login',
                        extra: {
                            login: true,
                        }
                    });
                    api.openWin({
                        name: 'user_login',
                        url: '../login/user_login.html',
                        reload: true,
                    });
                }
            } else {
                //  alert( JSON.stringify( err ) );
            }
        });
    }

    function fnClearCache() {
        api.showProgress({
            title: '清除中',
            modal: true
        });

        api.clearCache();
        setTimeout(function() {
            fnGetCacheSize();
        }, 1000);
    };

    function fnGetCacheSize() {
        api.getCacheSize(function(ret, err) {
            api.hideProgress();
            var size = parseInt(ret.size / 1048576 * 100) / 1000 + 'MB';

            // var size = parseInt(ret.size / 1024 / 1024 * 100) / 100 + ' MB';
            var cacheSize = $api.byId('cacheSize');
            cacheSize.innerHTML = size;
        });
    };

    function Check_update() {
        api.toast({
            msg: '当前已经是最新版本',
            duration: 2000,
            location: 'middle'
        });
    }
</script>

</html>
