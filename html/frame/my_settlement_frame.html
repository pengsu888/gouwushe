<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>账单明细</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style media="screen">
        html,
        body {
            height: 100%;
            width: 100%;
        }

        .headerItem .sx {
            height: auto;
            margin-top: 12px;
        }

        .sx_box {
            border-top: 1px solid #ddd;
            background: #fff;
            position: absolute;
            display: none;
            z-index: 1;
        }

        .sx {
            font-size: 12px;
            color: #666;
        }

        .sz_type {
            border-bottom: 1px solid #ddd;
            height: 70px;
            line-height: 70px;
            font-size: 14px;
            color: #444;
        }

        .sz_type span {
            padding-left: 5%;
            width: 18%;
        }

        .sz_type ul {
            float: right;
            width: 69%;
        }

        .sz_type ul li {
            float: left;
            background: #eee;
            color: #666;
            width: 26%;
            border-radius: 23px;
            height: 41px;
            margin-top: 14px;
            line-height: 41px;
            text-align: center;
            color: #9f9f9f;
            font-size: 16px;
        }

        .sz_type ul li.on {
            background: #fecfc5;
            color: #fd5f3e;
        }

        .sz_type ul li:nth-child(2),
        .sz_type ul li:nth-child(3) {
            margin-left: 8%;
        }

        .kj_sx {
            width: 90%;
            margin: 0 auto;
        }

        .kj_sx p {
            padding: 8% 0 2% 0;
            font-size: 14px;
            color: #444;
        }

        .kj_sx ul {}

        .kj_sx ul li {
            float: left;
            border-radius: 5px;
            height: 41px;
            margin-top: 14px;
            line-height: 41px;
            text-align: center;
            color: #9f9f9f;
            font-size: 16px;
            background: #eee;
            width: 30%;
        }

        .kj_sx ul li:nth-child(3n+2) {
            margin-left: 5%;
            margin-right: 5%;
        }

        .kj_sx ul li.on {
            background: #fecfc5;
            color: #fd5f3e;
        }

        .headerItem .sx img {
            width: 6px;
            height: 6px;
            margin: 0 0 0 5px;
        }

        .headerItem .header_back {
            width: auto;
        }

        .submitColor {
            background: #fff;
        }

        .headerItem .title_color {
            color: #333;
        }

        .aui-dialog-btn {
            position: relative;
            display: block;
            width: 100%;
            padding: 0 0.25rem;
            height: 2.2rem;
            font-size: 0.8rem;
            line-height: 2.2rem;
            text-align: center;
            color: #f94529;
            border-right: 1px solid #dddddd;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            -webkit-box-flex: 1;
            box-flex: 1;
        }

        .aui-dialog-body {
            padding: 0.75rem;
            overflow: hidden;
            font-size: 0.875em;
            color: #999;
        }

        .sx_btn {
            margin-top: 30%;
        }

        .sx_btn button {
            width: 48%;
            text-align: center;
            border-radius: 32px;
            background: #eee;
            padding: 4% 0 3% 0;
            margin-bottom: 5%;
        }

        .sx_btn button:nth-child(2) {
            margin-left: 2%;
            background: #fd5f3e;
            color: #fff;
        }
        /*列表*/

        .list {
            /*  padding-top: 12%;*/
        }

        .list_box {
            position: relative;
        }

        .list_count {
            background: #f5f5f5;
            padding: 0 4%;
            color: #333;
            /*display: none;*/
            /*position: fixed;*/
            z-index: : 99;
            /*width: 96%;*/
        }

        .list_count p:nth-child(1) {
            padding: 1% 0;
        }

        .list_count p:nth-child(2) {
            font-size: 14px;
            color: #999;
            padding-top: 1%;
        }

        .list_count p:nth-child(2) span {
            padding-right: 1%;
        }

        .list_count p:nth-child(2) span:nth-child(3) {
            padding-left: 3%;
        }

        .list_box .list_left p:nth-child(1) {
            padding-bottom: 2%;
            font-size: 0.85rem;
        }

        .list_box .list_left p:nth-child(2) {
            color: #999;
            font-size: 0.85rem;
        }

        .list_box .list_right {
            position: absolute;
            right: 3%;
            bottom: 9%;
        }

        .list_box .list_right .orange {
            color: #fd6c50;
            font-size: 0.85rem;
        }

        .list_box .list_right .green {
            color: #009966;
            font-size: 0.85rem;
        }

        .list_box ul {
            /*  padding-top: 10%;*/
        }

        .list_box ul li {
            position: relative;
            border-bottom: 1px solid #eee;
            padding: 3% 4%;
        }

        .choose_time {
            border: 1px solid #fd5f3e;
            width: 30%;
            margin: 0 auto;
            padding: 1% 0;
            height: 20px;
            line-height: 20px;
        }

        .fix_search_nav {
            border-top: 1px solid #f1f1f1;
            padding: 3% 5%;
            width: 100%;
            margin: 0 auto;
            position: fixed;
            z-index: 99;
            background: #fff;
        }

        .se {
            display: none;
        }

        .ding {
            position: fixed;
            z-index: 99;
        }

        .mark {
            position: fixed;
            width: 96%;
            background: #fff;
            z-index: 9;
            background: #f5f5f5;
            padding-left: 4%;
            height: 50px;
            display: none;
        }
    </style>
</head>

<body>


    <!--列表-->
    <!-- <div class="fix_search_nav"></div> -->
    <div class="list" id="list">
        <!-- <div class="mark"></div>
      <div class="content">
        <div class="list_box">
            <div class="list_count">
                <p>本月</p>
                <div class='se'>
                    <p style='font-size:14px;color:#999'>2018-12-20</p>
                    <p>2018-12-31</p>
                    <div class='ms'>

                      <p>
                          <span>收入</span><span>￥1896.54</span>
                          <span>支出</span><span>￥1896.54</span>
                      </p>
                    </div>
                </div>
            </div>
            <ul>
                <li>
                    <div class="list_left">
                        <p>签到奖励</p>
                        <p>2018-04-13 03:32:16</p>
                    </div>
                    <div class="list_right">
                        <span class="orange">+5集分宝</span>
                    </div>
                </li>
            </ul>
        </div>
        <div class="list_box">
            <div class="list_count">
                <p>本月</p>
                <div class='se'>
                    <p style='font-size:14px;color:#999'>2018-12-20</p>
                    <p>2018-12-31</p>
                    <div class='ms'>

                      <p>
                          <span>收入</span><span>￥1896.54</span>
                          <span>支出</span><span>￥1896.54</span>
                      </p>
                    </div>
                </div>
            </div>
            <ul>
                <li>
                    <div class="list_left">
                        <p>签到奖励</p>
                        <p>2018-04-13 03:32:16</p>
                    </div>
                    <div class="list_right">
                        <span class="orange">+5集分宝</span>
                    </div>
                </li>
            </ul>
        </div>
      </div> -->


    </div>
    <!--列表-->
    <div id="statu" style="font-size:0.8rem;color:#fd5f3e;height:30px;line-height:30px;text-align:center;clear:both;">
        <!-- 啊啊啊啊啊啊<div class="choose_time">选择时间</div><img src="../../image/loading.d997b79c.svg" alt="" style="width:1rem;height:1rem;vertical-align:middle;"> 加载中... -->
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery.js"></script>
<script type="text/javascript" src="../../script/fans_del.js"></script>
<script type="text/javascript" src="../../script/api_common.js"></script>
<script type="text/javascript" src="../../script/md5.js"></script>
<script type="text/javascript">
    var user_id;
    var pageNum = 1;
    var isOver = false; //默认没有取完数据
    var statu; //滑到底部状态
    var count = [];
    var mm = "";
    var yymm = "";
    apiready = function() {
        var type_id = api.pageParam.str;
        var tx_type = api.pageParam.tx_type;
        if (!empty($api.getStorage("userInfo"))) {
            user_id = $api.getStorage("userInfo").user_id;
        } else {
            user_id = '';
        }

        closePopframe();
        statu = $api.byId('statu');
        loadFresh();

        if (api.pageParam.tixian == 1) {
            loadMyFa(true, "", api.pageParam.spe_type);
        } else {
            loadMyFa(true, tx_type, type_id);
        }
        // 商品列表数据
        // 监听事件apiReady滚动到底部，加载更多功能
        api.addEventListener({
            name: 'scrolltobottom',
            extra: {
                threshold: 0 //设置距离底部多少距离时触发，默认值为0，数字类型
            }
        }, function(ret, err) {
            // loadMyFa(false, tx_type, type_id);
            if (api.pageParam.tixian == 1) {
                loadMyFa(false, "", api.pageParam.spe_type);
            } else {
                loadMyFa(false, tx_type, type_id);
            }
        });

    };

    function sx() {
        if ($(".sx_box").css("display") == 'none') {
            $(".sx").css("color", "#fd5f3e");
            $(".sx_box").css("display", "block");
            $("body").css("background-color", "rgba(0, 0, 0, 0.4)");
        } else {
            $(".sx").css("color", "#666");
            $(".sx_box").css("display", "none");
            $("body").css("background-color", "#fff");
        }
    }

    function loadFresh() {
        RefreshLoad();
    }

    function loadMyFa(isPull, tx_type, spe_type) {
        var star_time = "";
        var end_time = "";
        var month_date = "";
        //如果是按日期搜索
        if (api.pageParam.rq == 1) {
            star_time = $api.getStorage('select_time_byDay2').star_time;
            end_time = $api.getStorage('select_time_byDay2').end_time;
        }
        if (api.pageParam.rq == 2) {
            month_date = $api.getStorage('select_time_byMon2');
        }
        //alert(star_time+"//"+end_time+"//"+month_date)
        if (tx_type == "") {
            tx_type = 0 //默认为0
        }
        if (spe_type == "") {
            spe_type = ""
        }
        if (!isPull && isOver) {
            return;
        }
        //判断如果是下拉刷新，
        if (isPull) {
            pageNum = 1;
            isOver = false;
        }
        var obj = {
            'user_id': user_id,
            'tx_type': tx_type,
            'spe_type': spe_type,
            'start_time': star_time,
            'end_time': end_time,
            'month_date': month_date,
            'pageNo': pageNum,
            'size': 10
        };
        var objArr = sort_ASCII(obj);
        var timestamp = fntimestamp();
        var version = '2.0';
        var arr = apiSecret + timestamp + version + '';
        for (i in objArr) {
            arr += objArr[i];
        }
        var sign = hex_md5(arr);
        api.ajax({
            url: commonUrl + 'soukeAppTttService/service/user/findflow_ac',
            method: 'post',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            data: {
                body: {
                    'apiKey': apiKey,
                    'timestamp': timestamp,
                    'sign': sign,
                    'user_id': user_id,
                    'tx_type': tx_type,
                    'spe_type': spe_type,
                    'start_time': star_time,
                    'end_time': end_time,
                    'month_date': month_date,
                    'pageNo': pageNum,
                    'size': 10
                }
            }
        }, function(ret, err) {
            console.log("账单明细：" + JSON.stringify(ret));
            if (ret) {
                if (ret.result_code == 200) {
                    var data = ret.result_data.items;
                    var integral_name = ret.integral_name;
                    var star_time = "";
                    var end_time = "";
                    var month_date = "";
                    if ($api.getStorage('select_time_byDay2') != null || $api.getStorage('select_time_byMon2') != null) {
                        if ($api.getStorage('select_time_byDay2').star_time != "") {
                            star_time = $api.getStorage('select_time_byDay2').star_time;
                        }
                        if ($api.getStorage('select_time_byDay2').star_time == null) {
                            star_time = "";
                        }
                        if ($api.getStorage('select_time_byDay2').end_time != "") {
                            end_time = $api.getStorage('select_time_byDay2').end_time;
                        }
                        if ($api.getStorage('select_time_byDay2').end_time == null) {
                            end_time = "";
                        }
                        if ($api.getStorage('select_time_byMon2') != "") {
                            month_date = $api.getStorage('select_time_byMon2');
                        }
                    }
                    if (data != "") {
                        $api.css(statu, 'display:block;');
                        pageNum++;
                    } else {
                        if (star_time != "" && end_time != "" && month_date == "") {
                            statu.innerHTML = "没有找到" + star_time + "至" + end_time + "的相关记录 <div class='choose_time' onclick='selectTime();'>选择时间</div>";
                        }
                        if (star_time != "" && end_time == "") {
                            statu.innerHTML = "没有找到" + star_time + "的相关记录 <div class='choose_time' onclick='selectTime();'>选择时间</div>";
                        }
                        if (star_time == "" && end_time != "") {
                            statu.innerHTML = "没有找到" + end_time + "的相关记录 <div class='choose_time' onclick='selectTime();'>选择时间</div>";
                        }
                        if (star_time == "" && end_time == "" && month_date != "") {

                            statu.innerHTML = "没有找到" + month_date + "的相关记录 <div class='choose_time' onclick='selectTime();'>选择时间</div>";
                        }
                        if (star_time == "" && end_time == "" && month_date == "") {
                            statu.innerHTML = "暂无数据";
                        }
                    }
                    if (data.length < 10 && data != "") {
                        statu.innerHTML = "已经到底啦 ~ 别扯了";
                        isOver = true;
                    }
                    fnShowData(integral_name, data, isPull, star_time, end_time, month_date, tx_type, spe_type);
                    $(".se").eq(0).show();
                    //月份吸顶
                    if ($("div").hasClass('list_count')) {
                        $(".mark").show();
                        var top = $(".list_count:first").offset().top;
                        // window.scrollTo(0, top);
                        $(".mark").html($(".list_count:first").html());
                        var m_h = $(".list_count:first").height()
                        var titles = $(".list_count");
                        var obj = {};
                        for (var i = 0; i < titles.length; i++) {
                            obj["top" + i] = $(titles[i]).offset().top;
                        }
                        $(window).scroll(function() {
                            //如果页面向上拉伸的距离大于等于哪个title距离顶部的距离，就将哪个title中的文字给mark
                            for (var i = 0; i < titles.length; i++) {
                                if ($(window).scrollTop() == 0) {
                                    $(".mark").hide();
                                } else {
                                    $(".mark").show();
                                }
                                if ($(window).scrollTop() >= obj["top" + i] && $(window).scrollTop() <= obj["top" + (i + 1)]) {
                                    $(".mark").html($(".list_count").eq(i).html());
                                    $(".mark").height = m_h;
                                } else if ($(window).scrollTop() >= obj["top" + (titles.length - 1)] &&
                                    $(window).scrollTop() <= obj["top" + (titles.length - 1)] + parseFloat($(".list_count").eq(titles.length - 1).next('div').height())) {
                                    $(".mark").html($(".list_count").eq(titles.length - 1).html());
                                    $(".mark").css("height", m_h);
                                } else if ($(window).scrollTop() <= obj.top0) {
                                    $(".mark").html("");
                                    $(".mark").height = m_h;
                                } else if ($(window).scrollTop() >= obj["top" + (titles.length - 1)] + parseFloat($(".list_count").eq(titles.length - 1).next('div').height())) {
                                    $(".mark").html("");
                                    $(".mark").css("height", "0");
                                }
                            }
                        });
                    }
                } else {
                    api.toast({
                        msg: ret.result_message,
                        duration: 2000,
                        location: 'middle'
                    });
                }
            } else {
                //alert( JSON.stringify( err ) );
            }
        });
    }

    function count_function(month, now_momth, year, star_time, end_time, month_date, tx_type, spe_type) {
        if (month_date != null && month_date != '') {
            month = month_date;
        }
        if (tx_type == null) {
            tx_type = 0;
        }
        if (spe_type == null) {
            spe_type = "";
        }
        if (star_time == null && star_time != '') {
            star_time = "";
        }
        if (end_time == null && end_time != '') {
            end_time = "";
        }
        var obj = {
            'user_id': user_id,
            'tx_type': tx_type,
            'spe_type': spe_type,
            'month_date': month,
            'start_time': star_time,
            'end_time': end_time
        };
        console.log(JSON.stringify(obj));
        var objArr = sort_ASCII(obj);
        var timestamp = fntimestamp();
        var version = '2.0';
        var arr = apiSecret + timestamp + version + '';
        for (i in objArr) {
            arr += objArr[i];
        }
        var sign = hex_md5(arr);
        var html = "";
        api.ajax({
            url: commonUrl + 'soukeAppTttService/service/user/findflowTotal_c',
            method: 'post',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            data: {
                body: {
                    'apiKey': apiKey,
                    'timestamp': timestamp,
                    'sign': sign,
                    'user_id': user_id,
                    'tx_type': tx_type,
                    'spe_type': spe_type,
                    'month_date': month,
                    'start_time': star_time,
                    'end_time': end_time
                }
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.result_code == 200) {
                    console.log(JSON.stringify(ret));
                    var arr = ret.result_data;
                    var html = "";
                    html += "<p style='color:#666;font-size:13px'><span>收入</span>";
                    html += "<span>￥" + Math.floor(arr[1] * 100) / 100 + "</span>";
                    html += "<span style='padding-left:2%;'>支出</span>";
                    html += "<span>￥" + Math.floor(arr[3] * 100) / 100 + "</span>";
                    html += "</p>";
                    if (api.pageParam.rq == 1) {
                        $(".ms").eq(0).html(html)
                    } else {
                        $(".m" + year + now_momth).html(html)
                    }
                } else {
                    api.toast({
                        msg: ret.result_message,
                        duration: 2000,
                        location: 'middle'
                    });
                }
            } else {
                alert(JSON.stringify(err));
            }
        })
    }

    function fnShowData(integral_name, data, isPull, star_time, end_time, month_date, tx_type, spe_type) {
        var myDate = new Date();
        var now_year = myDate.getFullYear(); //获取当前年份(2位)
        var now_momth = myDate.getMonth() + 1;
        var arr = [];
        if (now_momth.toString().length == 1) {
            now_momth = '0' + now_momth;
        }
        var html = "";
        var j = "";
        //  alert( JSON.stringify( data) );
        html += "<div class='mark'></div>";
        html += "<div class='content'>";
        for (var i = 0; i < data.length; i++) {
            var comm_month = data[i].comm_time.slice(0, 7); //截取年份加月份
            var month = comm_month.slice(5, 7); //截取月份
            var year = comm_month.slice(0, 4); //获取年份
            html += "<div class='list_box'>";
            if (year == now_year) {
                if (mm != month) {
                    html += "<div class='list_count' id='ss" + year + month + "'>";
                    if (api.pageParam.rq == 1) {
                        star_time = $api.getStorage('select_time_byDay2').star_time;
                        end_time = $api.getStorage('select_time_byDay2').end_time;
                        html += "<div class='se'><p style='font-size:14px;color:#999'>" + star_time + "</p>";
                        html += "<p style='font-size:14px;color:#999'>" + end_time + "</p></div>";
                        html += "<div class='ms'>"
                        html += "</div>"

                    } else {
                        if (now_momth == month) {
                            html += "<p>本月</p>";
                        } else {
                            html += "<p>" + month + "月</p>";
                        }
                        html += "<div class='m" + year + month + "'>"
                        html += "</div>"
                    }
                    count_function(comm_month, month, year, '', '', '', tx_type, spe_type)
                    html += "</div>";
                }
                mm = month; //循环完月份存全局变量mm下次循环继续比对
                var specific_type = data[i].specific_type.toString();
                specific_type = specific_type.slice(0, 1);

                html += "<ul>";
                html += "<li><div class='list_left'><p>" + data[i].specific_name + "</p><p>" + data[i].comm_time + "</p></div>";

                if (specific_type == 1) {
                    html += "<div class='list_right'><span class='orange'>+￥" + data[i].price + "</span></div>";
                } else if (specific_type == 2) {
                    html += "<div class='list_right'><span class='orange'>+" + data[i].integral + integral_name + "</span></div>";
                } else if (specific_type == 3) {
                    html += "<div class='list_right'><span class='green'>-￥" + data[i].price + "</span></div>";
                } else if (specific_type == 4) {
                    html += "<div class='list_right'><span class='green'>-" + data[i].integral + integral_name + "</span></div>";
                }
                html += "</li>";
                html += "</ul></div>";
            } else {
                if (yymm != month) {
                    html += "<div class='list_count' id='ss" + year + month + "'>";
                    if (api.pageParam.rq == 1) {
                        star_time = $api.getStorage('select_time_byDay2').star_time;
                        end_time = $api.getStorage('select_time_byDay2').end_time;
                        html += "<div class='se'><p style='font-size:14px;color:#999'>" + star_time + "</p>";
                        html += "<p>" + end_time + "</p></div>";
                        html += "<div class='ms'>"
                        html += "</div>"
                    } else {
                        html += "<p>" + comm_month + "</p>";
                    }
                    html += "<div class='m" + year + month + "'>"
                    html += "</div>"
                    count_function(comm_month, month, year, '', '', '', tx_type, spe_type)
                    html += "</div>";
                }
                yymm = month; //存入不是当年的月份
                html += "<ul>";
                html += "<li><div class='list_left'><p>" + data[i].specific_name + "</p><p>" + data[i].comm_time + "</p></div>";
                var specific_type = data[i].specific_type.toString();
                specific_type = specific_type.slice(0, 1);
                if (specific_type == 1) {
                    html += "<div class='list_right'><span class='orange'>+￥" + data[i].price + "</span></div>";
                } else if (specific_type == 2) {
                    html += "<div class='list_right'><span class='orange'>+" + data[i].integral + integral_name + "</span></div>";
                } else if (specific_type == 3) {
                    html += "<div class='list_right'><span class='green'>-￥" + data[i].price + "</span></div>";
                } else if (specific_type == 4) {
                    html += "<div class='list_right'><span class='green'>-" + data[i].integral + integral_name + "</span></div>";
                }
                html += "</li>";
                html += "</ul></div>";
            }
        }
        html += "</div>";
        if (isPull) {
            $api.byId('list').innerHTML = html;
        } else {
            $api.byId('list').innerHTML += html;
            // var newhtml = $("#list").html() + html;
            // $("#list").html(newhtml)
        }
        // console.log($api.byId('list').innerHTML);
        $(".copy_btn").click(function() {
            var clipBoard = api.require('clipBoard');
            clipBoard.set({
                value: $(this).attr("id")
            }, function(ret, err) {
                if (ret) {
                    // alert(JSON.stringify(ret));
                    api.toast({
                        msg: '复制成功',
                        duration: 2000,
                        location: 'middle'
                    });

                } else {
                    // alert(JSON.stringify(err));
                }
            });
        })

    }

    function closeWin() {
        api.closeWin({
            name: 'my_settlement_win'
        });
    }
    //打开筛选蒙版
    window.showFlag = false;

    function sx(tx_type, str) {
        if (str != null && tx_type != null) { //选完筛选传值
            openFrame(tx_type, str)
        }
        $(".sx").css("color", "#fd5f3e");
        $(".sx img").attr("src", "../../image/huaqian_icon_uparrow_selected.png");

        $(".header_down").addClass("header_up");
        var header = $api.byId('header');
        var $body = $api.dom('body');
        var body_h = $api.offset($body).h;
        var headerH = $api.offset(header).h;
        if (window.showFlag == false) {
            api.openFrame({
                name: 'settlement_slidLayout',
                url: '../my/settlement_slidLayout.html',
                rect: {
                    x: 0,
                    y: headerH,
                    w: 'auto',
                    h: body_h
                },
                // pageParam : {
                // 	Id:id
                // },
                bounces: false,
                bgColor: 'rgba(0,0,0,0)',
                vScrollBarEnabled: true,
                hScrollBarEnabled: true
            });
            window.showFlag = true;
        } else {
            closeOrderSlidLayout();
        }
    }

    function closeOrderSlidLayout() {
        $(".sx").css("color", "#666");
        $(".sx img").attr("src", "../../image/huaqian_icon_downarrow_default.png");
        $(".header_down").removeClass("header_up");
        api.closeFrame({
            name: 'settlement_slidLayout'
        });
        window.showFlag = false;
    }
    //日期筛选页面
    function selectTime() {
        api.openWin({
            name: 'select_time_settlement_win',
            url: '../frame/select_time_settlement_win.html',
            pageParam: {
                name: 'test'
            }
        });
    }
</script>

</html>
