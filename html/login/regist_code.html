<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>短信验证码</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" href="../../css/aui.css">

    <style>
        html,
        body {
            background-color: #fff;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .closeIcon {
            height: 0.9rem;
            width: 0.9rem;
            position: absolute;
            top: 2.0rem;
            left: 1.0rem;
        }

        img {
            width: 100%;
            height: 100%;
            background-size: 100% 100%;
        }

        .registItem {
            width: 80%;
            height: 10rem;
            margin: 5rem auto;
            position: absolute;
            left: 10%;
            top: 3%;
        }

        .regist_title {
            font-size: 1.5rem;
            color: #757575;
            /*margin-left: -1rem;*/
        }

        .regist_input {
            width: 100%;
            height: 2.0rem;
            border-bottom: solid 1px #ccc;
            margin-top: 1rem;
            position: relative;
        }

        .scannerImg {
            height: 0.85rem;
            width: 0.85rem;
            background-size: 100% 100%;
            position: absolute;
            right: 0;
            bottom: 0.7rem;
        }

        .clear_phone {
            height: 0.85rem;
            width: 0.85rem;
            background-size: 100% 100%;
            display: none;
            position: absolute;
            right: 0;
            bottom: 0.7rem;
        }

        .regist_input input {
            width: calc(100% - 2rem);
            height: 2rem;
            outline: none;
            border: none;
            caret-color: #FF2220;
        }

        .registBtn,
        .phone_registBtn,
        .login_registBtn {
            width: 100%;
            height: 2rem;
            text-align: center;
            color: #fff;
            background: #CCCCCC;
            border-radius: 5rem;
            line-height: 2rem;
            margin-top: 2rem;
        }

        .registBtn_active,
        .phone_registBtn_active,
        .login_registBtn_active {
            width: 100%;
            height: 2rem;
            text-align: center;
            color: #fff;
            background: #FF2220;
            border-radius: 5rem;
            line-height: 2rem;
            margin-top: 1rem;
            display: none;
        }

        .china {
            color: #757575;
            line-height: 2.0rem;
        }

        .black_color {
            color: #333;
        }

        .regist_tip {
            height: 3.0rem;
            line-height: 3.0rem;
            color: #ccc;
        }
        /*#loginByPhone{
      display: none;
    }
    #dx_yzm{
      display: none;
    }*/

        .yzm_input {
            width: 100%;
            height: 2.0rem;
            margin-top: 1.5rem;
        }

        .trade-password {
            display: flex;
            justify-content: center;
            position: relative;
            margin-top: 0.6rem;
            width: 100%;
        }

        .trade-password-input {
            position: absolute;
            width: 5.7rem;
            height: 1.5rem;
            top: -0.3rem;
            opacity: 0;
            font-size: 0.01rem;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            -ms-appearance: none;
            resize: none;
            outline: none;
            z-index: 1;
        }

        .trade-password .input-juli {
            float: left;
            width: 20%;
            height: 1.88rem;
            line-height: 1.88rem;
            flex: none;
            margin-right: 5%;
            border-bottom: 1px solid #d6d6d6;
            text-align: center;
            -webkit-appearance: none;
            -moz-appearance: none;
            -ms-appearance: none;
            resize: none;
            outline: none;
        }

        .fasong {
            height: 1.5rem;
            font-size: 0.7rem;
            width: 100%;
            color: #ccc;
            line-height: 1.5rem;
        }

        .xieyi {
            height: 5.0rem;
            width: 100%;
            line-height: 5.0rem;
            text-align: center;
            color: #ccc;
            font-size: 0.7rem;
        }

        .xieyi span {
            color: #FF2220;
        }
        /*修改aui中dialog样式*/

        .aui-dialog-btn {
            position: relative;
            display: block;
            width: 100%;
            padding: 0 0.25rem;
            height: 2.2rem;
            font-size: 0.8rem;
            line-height: 2.2rem;
            text-align: center;
            color: #888888;
            border-right: 1px solid #dddddd;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            -webkit-box-flex: 1;
            box-flex: 1;
        }

        .aui-dialog-btn:last-child {
            border-right: none;
            color: #FF2220;
        }

        .aui-dialog-body {
            padding: 1.5rem;
            overflow: hidden;
            font-size: 0.875em;
            color: #333;
        }
        /*改变input光标颜色*/

        input {
            caret-color: #FF2220;
        }

        .tjr {
            width: 100%;
            height: 4.4rem;
            margin: 1rem auto;
            display: none;
        }

        .tjr ul {
            list-style: none;
            padding: 0.5rem;
            margin: 0;
            height: 100%;
            border: solid 1px #ccc;
            border-radius: 0.5rem;
        }

        .tjr ul li {
            float: left;
            height: 100%;
        }

        .tjr ul li:nth-child(1) {
            width: 25%;
        }

        .tjr ul li img {
            width: 100%;
            height: 100%;
            background-size: 100% 100%;
            /*border-radius: 50px*/
        }

        .tjr ul li:nth-child(2) {
            width: 75%;
            position: relative;
        }

        .tjr ul li div.tjr_name {
            position: absolute;
            left: 0.5rem;
            top: 0;
        }

        .tjr ul li div.tjr_app {
            position: absolute;
            left: 0.5rem;
            bottom: 0;
            color: #ccc;
            font-size: 0.6rem;
        }
    </style>
</head>

<body>
    <div class="closeIcon" tapmode onclick="closeWin();"><img src="../../image/nav_back.png" alt=""></div>
    <!-- 获取短信验证码 begin-->
    <div class="registItem" id="dx_yzm">
        <div class="regist_title black_color">输入短信验证码</div>
        <div class="regist_tip">验证码已发送至<span id="get_phone"></span></div>
        <div class="yzm_input">
            <div class="trade-password" id="yqmItem">
                <input type="tel" maxlength="1" class="input-juli yzm_input" id='Yzm1'>
                <input type="tel" maxlength="1" class="input-juli yzm_input" id='Yzm2'>
                <input type="tel" maxlength="1" class="input-juli yzm_input" id='Yzm3'>
                <input type="tel" maxlength="1" class="input-juli yzm_input" id='Yzm4'>
            </div>
        </div>
        <div class="fasong">60秒后重新发送</div>
        <!-- <div class="login_registBtn">登录</div> -->
        <div class="login_registBtn_active" id="p_regist" tapmode onclick="fnLogin();">登录</div>
        <div class="login_registBtn_active" id="bywx_regist" tapmode onclick="fnLogin_wx();">登录</div>
    </div>
    <!-- 获取短信验证码 end-->
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery.js"></script>
<script type="text/javascript" src="../../script/aui-dialog.js"></script>
<script type="text/javascript" src="../../script/api_common.js"></script>
<script type="text/javascript" src="../../script/md5.js"></script>
<script type="text/javascript">
    var signLog;
    var user_nick, user_head, user_sex, return_value;
    apiready = function() {
        $api.byId('get_phone').innerHTML = api.pageParam.user_phone;
        clipBoard();
        time();
        getYzm();
        if (api.pageParam.ret_status) {
            $("#p_regist").hide();
            $("#bywx_regist").show();
            var wx_login = $api.getStorage("wx_login");
            user_nick = wx_login.user_nick;
            user_head = wx_login.user_head;
            user_sex = wx_login.user_sex;
            return_value = wx_login.return_value;
        } else {
            $("#p_regist").show();
            $("#bywx_regist").hide();
        }

    }

    function clipBoard() {
        var clipBoard = api.require('clipBoard');
        clipBoard.setListener(function(ret, err) {
            if (ret) {
                // alert(JSON.stringify(ret));
                // var yqmItem = ret.value;
                var reg = new RegExp("^[0-9]{4}$");
                var i = ret.value;
                if (reg.test(i)) {
                    $("#Yzm1").val(i.substring(0, 1));
                    $("#Yzm2").val(i.substring(1, 2));
                    $("#Yzm3").val(i.substring(2, 3));
                    $("#Yzm4").val(i.substring(3, 4));
                }
            } else {
                // alert(JSON.stringify(err));
            }
        });
    }

    function fnLogin() {
        var phone_input = $(".input-juli");
        var yzm = "";
        for (var i = 0; i < phone_input.length; i++) {
            yzm += $(phone_input[i]).val() + '';
        }
        var obj;
        if (api.pageParam.invitation_code == undefined) {
            obj = {
                'user_phone': api.pageParam.user_phone,
                'user_dynamic_code': yzm,
                'device_id': ''
            };
        } else {
            obj = {
                'user_phone': api.pageParam.user_phone,
                'user_dynamic_code': yzm,
                'device_id': '',
                'invitation_code': api.pageParam.invitation_code
            };
        }
        var objArr = sort_ASCII(obj);
        var timestamp = fntimestamp();
        var version = '2.0';
        var arr = apiSecret + timestamp + version + '';
        for (i in objArr) {
            arr += objArr[i];
        }
        var sign = hex_md5(arr);
        var data;
        if (api.pageParam.invitation_code == undefined) {
            data = {
                'apiKey': apiKey,
                'timestamp': timestamp,
                'sign': sign,
                'user_phone': api.pageParam.user_phone,
                'user_dynamic_code': yzm,
                'device_id': ''
            }
        } else {
            data = {
                'apiKey': apiKey,
                'timestamp': timestamp,
                'sign': sign,
                'user_phone': api.pageParam.user_phone,
                'user_dynamic_code': yzm,
                'device_id': '',
                'invitation_code': api.pageParam.invitation_code
            }
        }

        api.ajax({
            url: commonUrl + 'soukeAppTttService/service/user/quicklogin_ac',
            method: 'post',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            data: {
                body: data
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.result_code == 200) {
                    console.log("登录：" + JSON.stringify(ret));
                    // openinstall上报注册数据
                    if (openinstaus == 1) {
                        var openinstall = api.require('openinstall');
                        openinstall.reportRegister();
                    }
                    api.toast({
                        msg: '注册成功',
                        duration: 2000,
                        location: 'middle'
                    });
                    var userInfo = {
                        'user_id': ret.result_user_id,
                        'user_token': ret.result_token
                    };
                    $api.setStorage('userInfo', userInfo);
                    api.sendEvent({
                        name: 'login',
                        extra: {
                            login: true,
                        }
                    });
                    api.closeToWin({
                        name: 'root'
                    });

                } else {
                    api.toast({
                        msg: ret.result_message,
                        duration: 2000,
                        location: 'middle'
                    });

                }
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
        });
    }

    function fnLogin_wx() {
        var phone_input = $(".input-juli");
        var yzm = "";
        for (var i = 0; i < phone_input.length; i++) {
            yzm += $(phone_input[i]).val() + '';
        }
        var obj;
        if (api.pageParam.invitation_code == undefined) {
            obj = {
                'user_phone': api.pageParam.user_phone,
                'user_code': yzm,
                'device_id': '',
                'open_id': return_value,
                'user_nick': encodeURIComponent(user_nick),
                'user_head': user_head,
                'user_sex': user_sex
            };
        } else {
            obj = {
                'user_phone': api.pageParam.user_phone,
                'user_code': yzm,
                'device_id': '',
                'invitation_code': api.pageParam.invitation_code,
                'open_id': return_value,
                'user_nick': encodeURIComponent(user_nick),
                'user_head': user_head,
                'user_sex': user_sex
            };
        }
        var objArr = sort_ASCII(obj);
        var timestamp = fntimestamp();
        var version = '2.0';
        var arr = apiSecret + timestamp + version + '';
        for (i in objArr) {
            arr += objArr[i];
        }
        console.log(arr);
        var sign = hex_md5(arr);
        var data;
        if (api.pageParam.invitation_code == undefined) {
            data = {
                'apiKey': apiKey,
                'timestamp': timestamp,
                'sign': sign,
                'user_phone': api.pageParam.user_phone,
                'user_code': yzm,
                'device_id': '',
                'open_id': return_value,
                'user_nick': user_nick,
                'user_head': user_head,
                'user_sex': user_sex
            }
        } else {
            data = {
                'apiKey': apiKey,
                'timestamp': timestamp,
                'sign': sign,
                'user_phone': api.pageParam.user_phone,
                'user_code': yzm,
                'device_id': '',
                'invitation_code': api.pageParam.invitation_code,
                'open_id': return_value,
                'user_nick': user_nick,
                'user_head': user_head,
                'user_sex': user_sex
            }
        }
        api.ajax({
            url: commonUrl + 'soukeAppTttService/service/user/bingphone_ac',
            method: 'post',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            data: {
                body: data
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.result_code == 200) {
                    console.log("登录：" + JSON.stringify(ret));
                    if (openinstaus == 1) {
                        var openinstall = api.require('openinstall');
                        openinstall.reportRegister();
                    }
                    api.toast({
                        msg: '注册成功',
                        duration: 2000,
                        location: 'middle'
                    });
                    var userInfo = {
                        'user_id': ret.result_user_id,
                        'user_token': ret.result_token_text
                    };
                    $api.setStorage('userInfo', userInfo);
                    api.sendEvent({
                        name: 'login',
                        extra: {
                            login: true,
                        }
                    });
                    api.closeToWin({
                        name: 'root'
                    });
                } else {
                    api.toast({
                        msg: ret.result_message,
                        duration: 2000,
                        location: 'middle'
                    });

                }
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
        });
    }
    //监听输入框的值，当值不等于空的时候跳转到下一个输入框
    $('.input-juli').on('keyup', function(event) {
        if ($(this).val() != '') {
            if ($(this).index() < 6) {
                $(this).next('input').focus();
            }

        }
    });
    //发送验证码
    var wait = 60;

    function time() {
        if (wait == 0) {;
            $(".fasong").html("获取验证码");
            $(".fasong").css("color", "#f94529");
            $(".fasong").click(function() {
                fnGoNext();
                getYzm();
            })
            wait = 60;
        } else {
            fnGoNext();
        }
    };

    function fnGoNext() {
        $(".fasong").css("color", "#ccc");
        $(".fasong").html(wait + "秒后重新获取");
        wait--;
        setTimeout(function() {
            time();
        }, 1000)
    }
    //获取验证码
    function getYzm() {
        var obj;
        if (api.pageParam.invitation_code == undefined) {
            obj = {
                'user_phone': api.pageParam.user_phone
            };
        } else {
            obj = {
                'user_phone': api.pageParam.user_phone,
                'invitation_code': api.pageParam.invitation_code
            };
        }
        var objArr = sort_ASCII(obj);
        var timestamp = fntimestamp();
        var version = '2.0';
        var arr = apiSecret + timestamp + version + '';
        for (i in objArr) {
            arr += objArr[i];
        }
        var sign = hex_md5(arr);
        var data;
        if (api.pageParam.invitation_code == undefined) {
            data = {
                'apiKey': apiKey,
                'timestamp': timestamp,
                'sign': sign,
                'user_phone': api.pageParam.user_phone
            }
        } else {
            data = {
                'apiKey': apiKey,
                'timestamp': timestamp,
                'sign': sign,
                'user_phone': api.pageParam.user_phone,
                'invitation_code': api.pageParam.invitation_code
            }
        }
        api.ajax({
            url: commonUrl + 'soukeAppTttService/service/user/checkcellphoneadd_ac',
            method: 'post',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            data: {
                body: data
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.result_code == 200) {
                    console.log(JSON.stringify(ret));
                    api.toast({
                        msg: '发送成功',
                        duration: 2000,
                        location: 'middle'
                    });

                } else {
                    api.toast({
                        msg: '发送失败',
                        duration: 2000,
                        location: 'middle'
                    });

                }
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
        });
    }
    //监听输入框按下的时候，当输入框为空的时候删除下一个
    $('.input-juli').on('keydown', function(event) {
        var evt = event || window.event;
        if ($(this).val() == '' && evt.keyCode == 8) {
            // 如果为空且按下退回键
            $(this).prev('input').focus();
        }
    });

    function closeWin() {
        api.closeWin({
            name: 'regist_code'
        });
    }
</script>

</html>
